package fr.paris.lutece.plugins.mylutece.modules.saml.authentication.engine;

import junit.framework.TestCase;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.config.ConfigProperties;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.config.Constants;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.CertificateValidationException;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.InvalidAttributeException;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.SAMLCheckerException;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.SAMLParsingException;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.SAMLTokenExtractorException;
import fr.paris.lutece.plugins.mylutece.modules.saml.authentication.exceptions.SignatureValidationException;
import fr.paris.lutece.test.MokeHttpServletRequest;

public class SAMLTokenHandlerTest extends TestCase {

	@Override
	protected void setUp() throws Exception {
		ConfigProperties.getInstance().setTest(true);
	}

	public void testCheckSAMLResponseOK() {
		MokeHttpServletRequest request = new MokeHttpServletRequest();
		String validResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbHA6UmVzcG9uc2UgeG1sbnM6c2FtbHA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIiBJRD0iX2FiMzkyZDRjNWFmNjljNDY5NDc3MjY2OGQ1NTMzNzQ0IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfODYwYmMwYjhhNTRlMWYxZjc5YWRjM2RmNzkwYjEwYzUiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpTaWduZWRJbmZvIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpSZWZlcmVuY2UgVVJJPSIjXzg2MGJjMGI4YTU0ZTFmMWY3OWFkYzNkZjc5MGIxMGM1IiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpUcmFuc2Zvcm1zIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIvPgo8ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGVjOkluY2x1c2l2ZU5hbWVzcGFjZXMgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgUHJlZml4TGlzdD0iZHMgc2FtbCB4cyIvPjwvZHM6VHJhbnNmb3JtPgo8L2RzOlRyYW5zZm9ybXM+CjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4KPGRzOkRpZ2VzdFZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj50VG9sTlA5ZWQvVE5hQk0vREREdWJSUHpBT2s9PC9kczpEaWdlc3RWYWx1ZT4KPC9kczpSZWZlcmVuY2U+CjwvZHM6U2lnbmVkSW5mbz4KPGRzOlNpZ25hdHVyZVZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KYVdOT0ZkZEJxaldSRTQ0TldHWlRIYTBqR2VwUTdSU2ZBZ3lUQmprS3F0YVZQTlpBSXhGKzg3Y213T3NmUEQvV2k3bWhuQzJ1SEFvVwpzK1VidzdqazlhUHJ5T1RxcWlzaDJWcmQxNkRPSUhMdWFCdFNlMlZ6Vm9Uby9WUzF5RyswTVJVN0diKzBiS0xkc3NNb1YrR21JUWJiCncwV0xyMy93OWFDVnBGU05DMkdLQnJmYW1nWHZCM1AzRzlhRCs0UFFtb2FGdnAzZFprQ3c2NmxOYWtGcngxbWZHM1F4eXFEZjl1SXQKQVN6OU1BdmUyS3B0WWROV2tPa2JMcGRhTEZVdHRSNU9RRXoxTHYxd05vT0JpYW5pRGR0NXB2RzdlcjlQUXI3WnVhaDhZSjlYTTRGSApPZ3RONXlPeHUwS04vVkg2K2hnNjlhbXV2SDhMMCs4dTE3amx1UT09CjwvZHM6U2lnbmF0dXJlVmFsdWU+CjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUVpakNDQTNLZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRVUZBRENCZ0RFUk1BOEdBMVVFQXhNSWNHRnlhWE11Wm5JeEN6QUoKQmdOVkJBWVRBbVp5TVJZd0ZBWURWUVFJRXcxSmJHVWdaR1VnUm5KaGJtTmxNUTR3REFZRFZRUUhFd1ZRWVhKcGN6RVlNQllHQTFVRQpDaE1QVFdGcGNtbGxJR1JsSUZCaGNtbHpNUnd3R2dZSktvWklodmNOQVFrQkZnMXliMjkwUUhCaGNtbHpMbVp5TUI0WERUQTRNRGN5Ck9ERTFOREV4TWxvWERUQTVNRGN5T0RFMU5ERXhNbG93ZmpFTE1Ba0dBMVVFQmhNQ1puSXhGakFVQmdOVkJBZ1REVWxzWlNCa1pTQkcKY21GdVkyVXhHREFXQmdOVkJBb1REMDFoYVhKcFpTQmtaU0JRWVhKcGN6RU1NQW9HQTFVRUN4TURhV1J3TVJFd0R3WURWUVFERXdodwpZWEpwY3k1bWNqRWNNQm9HQ1NxR1NJYjNEUUVKQVJZTmNtOXZkRUJ3WVhKcGN5NW1jakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnRVBBRENDQVFvQ2dnRUJBTkVQSVhMMmMrWFFBNEJ6QjM3YWRaS1dmN1VkeVRNZFN4M29KOWxnS3VtM0NnTjZmUWNBR3NqTFY3WHYKR0lwdDc2cS84NUdmanR2UDBYNlNwVUo4VzYyTDRPVjExbmlXMjR2UTRscVFlMGJDa1hCZ3RDVkUyYS9nZFdxNkdjUjcxOUdPSXF5egpSWHhWc3VEVGdCei8xd3NGMmJOeUdLZXBwQ0NBMDY0U2JHZURoTGo3RW81YmN6aHEzMFBTM2lCeVp1WVp3N3dmbFQ1T01wWGxBZ1hICmlpWWFRaEpWcXp4T1ZsZlE0b21DWlkvb1M5Zlo4alN6MjU2WnllSHV3NnRqeGordEhsSHJQa0xiMGlDSlQrTHMrRmJYQ09nODNDWWgKcy9LM2FxSk5pN24veFM4cGhXSDd1Y29nVklUWHF3bW9EMmdoUXN5ZEdqNjNxdys5eTVPcDZjc0NBd0VBQWFPQ0FRNHdnZ0VLTUFrRwpBMVVkRXdRQ01BQXdIUVlEVlIwT0JCWUVGQzdHcUlEb0xRL1hiZjMrYzFKTTN2SDhlK0F3TUlHdEJnTlZIU01FZ2FVd2dhS0FGQTZMCnpJMXhXOHJwOUFoUERHR1F0cmFLckt0S29ZR0dwSUdETUlHQU1SRXdEd1lEVlFRREV3aHdZWEpwY3k1bWNqRUxNQWtHQTFVRUJoTUMKWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCR2NtRnVZMlV4RGpBTUJnTlZCQWNUQlZCaGNtbHpNUmd3RmdZRFZRUUtFdzlOWVdseQphV1VnWkdVZ1VHRnlhWE14SERBYUJna3Foa2lHOXcwQkNRRVdEWEp2YjNSQWNHRnlhWE11Wm5LQ0FRQXdMZ1lKWUlaSUFZYjRRZ0VFCkJDRVdIMmgwZEhCek9pOHZkM2QzTG5CaGNtbHpMbVp5TDJOaExXTnliQzV3Wlcwd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFBTDgKTGtkK3liYm5OazFXczQwR1RCaW1ZZlMycjd4U3VRVmpLTHg0MEVhUFhPem5Gbmc0VGNDK3Z4dWUxUEt3NzJsb2QreVcycjdJRE91RgpKaTVCbzNudm1hMjdRQ1lSYUgvRGQwSDdDcG9HVFdZeXZVQ294NXROSVB3dVFNTWJiZmtJMWgreW1IbUZ5dVNyS1laakNTRFkvWk9CCk4wOXhxOC84a3pZaWE1c1JTYW0rajdUTkl5clFLNzg5d28zRjRta25rWE5rZWoyWFFScFlqMTNCYzd1MkF3MEI1eTVQMTRZbG9DTjUKU0RYeDAvb29BOEJ6RWRwWnJpTEpYMis0NlV4UUdRRFVNTzBTemo1L0xnVC9wWWdoRmtMczM5ck5DUy9Gb2hmbFl5SzFGWnlkSWZSNQpETENMVGhhWkh3c2o4V0ZodDljMHAyM1JJNzhvYzFUdkFBaz08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDpTdWJqZWN0IHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI+X2NhN2U4ZDMwMWI1MTkzM2FjYzFlNmIxNjNkNDU3NDc1PC9zYW1sOk5hbWVJRD48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgQWRkcmVzcz0iMTcyLjMwLjI0LjE3IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIE5vdE9uT3JBZnRlcj0iMjAwOC0wOC0yMFQwODo0OTozOS4yMDBaIiBSZWNpcGllbnQ9Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIi8+PC9zYW1sOlN1YmplY3RDb25maXJtYXRpb24+PC9zYW1sOlN1YmplY3Q+PHNhbWw6Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMDgtMDgtMjBUMDg6NDQ6MzkuMjAwWiIgTm90T25PckFmdGVyPSIyMDA4LTA4LTIwVDA4OjQ5OjM5LjIwMFoiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWw6QXVkaWVuY2U+dXJuOmZzOnZvdGUucGFyaXMuZnI6MS4wPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0MzoxMC4yNDFaIiBTZXNzaW9uSW5kZXg9IjA3NjQzMWM5OGZiZGMwM2I1N2ZhNmU2ZGY5MTQwMDQ3NDkzZGYyZjViYTZjZmY4M2RmYjBkZThkN2EwYWE1NmEiIFNlc3Npb25Ob3RPbk9yQWZ0ZXI9IjIwMDgtMDgtMjBUMDk6MTM6MTAuMjQxWiIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6U3ViamVjdExvY2FsaXR5IEFkZHJlc3M9IjE3Mi4zMC4yNC4xNyIvPjxzYW1sOkF1dGhuQ29udGV4dD48c2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWw6QXV0aG5Db250ZXh0Pjwvc2FtbDpBdXRoblN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGVTdGF0ZW1lbnQgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5zdWZmaXgiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQuc3VmZml4IiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPmJpczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVpZCIgTmFtZT0idXJuOm9pZDowLjkuMjM0Mi4xOTIwMDMwMC4xMDAuMS4xIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hYmVub2l0QHBhcmlzLmZyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5udW1iZXIiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubnVtYmVyIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPjE1Mjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubmFtZSIgTmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5uYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPk1hbGFrb2ZmPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC51cmJhbmRpc3RyaWN0IiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnVyYmFuZGlzdHJpY3QiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+MTY8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnR5cGUiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQudHlwZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hdmVudWU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=";

		SAMLTokenHandler tokenChecker = new SAMLTokenHandler();

		// Requete valide (signature OK + certificat OK)
		request.addMokeParameters(Constants.SAML_RESPONSE_REQUEST_PARAM, validResponse);
		BootStrap.getInstance().initializeIDPMetaData("/resources/data/valid-idp-metadata.xml");
		BootStrap.getInstance().initializeSPMetaData("/resources/data/BureauDeVote.xml");
		
		try {
			tokenChecker.checkSAMLResponse(request);
		} catch (SAMLTokenExtractorException e) {
			fail("Requete invalide");
		} catch (SignatureValidationException e) {
			fail("Requete invalide");
		} catch (CertificateValidationException e) {
			fail("Requete invalide");
		} catch (InvalidAttributeException e) {
			fail("Requete invalide");
		} catch (SAMLParsingException e) {
			fail("Requete invalide");
		} catch (SAMLCheckerException e) {
			// OK Assertion expirée
		}
	}

	public void testCheckSAMLResponseInvalidCert() {
		MokeHttpServletRequest request = new MokeHttpServletRequest();
		String validResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbHA6UmVzcG9uc2UgeG1sbnM6c2FtbHA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIiBJRD0iX2FiMzkyZDRjNWFmNjljNDY5NDc3MjY2OGQ1NTMzNzQ0IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfODYwYmMwYjhhNTRlMWYxZjc5YWRjM2RmNzkwYjEwYzUiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpTaWduZWRJbmZvIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpSZWZlcmVuY2UgVVJJPSIjXzg2MGJjMGI4YTU0ZTFmMWY3OWFkYzNkZjc5MGIxMGM1IiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpUcmFuc2Zvcm1zIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIvPgo8ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGVjOkluY2x1c2l2ZU5hbWVzcGFjZXMgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgUHJlZml4TGlzdD0iZHMgc2FtbCB4cyIvPjwvZHM6VHJhbnNmb3JtPgo8L2RzOlRyYW5zZm9ybXM+CjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4KPGRzOkRpZ2VzdFZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj50VG9sTlA5ZWQvVE5hQk0vREREdWJSUHpBT2s9PC9kczpEaWdlc3RWYWx1ZT4KPC9kczpSZWZlcmVuY2U+CjwvZHM6U2lnbmVkSW5mbz4KPGRzOlNpZ25hdHVyZVZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KYVdOT0ZkZEJxaldSRTQ0TldHWlRIYTBqR2VwUTdSU2ZBZ3lUQmprS3F0YVZQTlpBSXhGKzg3Y213T3NmUEQvV2k3bWhuQzJ1SEFvVwpzK1VidzdqazlhUHJ5T1RxcWlzaDJWcmQxNkRPSUhMdWFCdFNlMlZ6Vm9Uby9WUzF5RyswTVJVN0diKzBiS0xkc3NNb1YrR21JUWJiCncwV0xyMy93OWFDVnBGU05DMkdLQnJmYW1nWHZCM1AzRzlhRCs0UFFtb2FGdnAzZFprQ3c2NmxOYWtGcngxbWZHM1F4eXFEZjl1SXQKQVN6OU1BdmUyS3B0WWROV2tPa2JMcGRhTEZVdHRSNU9RRXoxTHYxd05vT0JpYW5pRGR0NXB2RzdlcjlQUXI3WnVhaDhZSjlYTTRGSApPZ3RONXlPeHUwS04vVkg2K2hnNjlhbXV2SDhMMCs4dTE3amx1UT09CjwvZHM6U2lnbmF0dXJlVmFsdWU+CjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUVpakNDQTNLZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRVUZBRENCZ0RFUk1BOEdBMVVFQXhNSWNHRnlhWE11Wm5JeEN6QUoKQmdOVkJBWVRBbVp5TVJZd0ZBWURWUVFJRXcxSmJHVWdaR1VnUm5KaGJtTmxNUTR3REFZRFZRUUhFd1ZRWVhKcGN6RVlNQllHQTFVRQpDaE1QVFdGcGNtbGxJR1JsSUZCaGNtbHpNUnd3R2dZSktvWklodmNOQVFrQkZnMXliMjkwUUhCaGNtbHpMbVp5TUI0WERUQTRNRGN5Ck9ERTFOREV4TWxvWERUQTVNRGN5T0RFMU5ERXhNbG93ZmpFTE1Ba0dBMVVFQmhNQ1puSXhGakFVQmdOVkJBZ1REVWxzWlNCa1pTQkcKY21GdVkyVXhHREFXQmdOVkJBb1REMDFoYVhKcFpTQmtaU0JRWVhKcGN6RU1NQW9HQTFVRUN4TURhV1J3TVJFd0R3WURWUVFERXdodwpZWEpwY3k1bWNqRWNNQm9HQ1NxR1NJYjNEUUVKQVJZTmNtOXZkRUJ3WVhKcGN5NW1jakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnRVBBRENDQVFvQ2dnRUJBTkVQSVhMMmMrWFFBNEJ6QjM3YWRaS1dmN1VkeVRNZFN4M29KOWxnS3VtM0NnTjZmUWNBR3NqTFY3WHYKR0lwdDc2cS84NUdmanR2UDBYNlNwVUo4VzYyTDRPVjExbmlXMjR2UTRscVFlMGJDa1hCZ3RDVkUyYS9nZFdxNkdjUjcxOUdPSXF5egpSWHhWc3VEVGdCei8xd3NGMmJOeUdLZXBwQ0NBMDY0U2JHZURoTGo3RW81YmN6aHEzMFBTM2lCeVp1WVp3N3dmbFQ1T01wWGxBZ1hICmlpWWFRaEpWcXp4T1ZsZlE0b21DWlkvb1M5Zlo4alN6MjU2WnllSHV3NnRqeGordEhsSHJQa0xiMGlDSlQrTHMrRmJYQ09nODNDWWgKcy9LM2FxSk5pN24veFM4cGhXSDd1Y29nVklUWHF3bW9EMmdoUXN5ZEdqNjNxdys5eTVPcDZjc0NBd0VBQWFPQ0FRNHdnZ0VLTUFrRwpBMVVkRXdRQ01BQXdIUVlEVlIwT0JCWUVGQzdHcUlEb0xRL1hiZjMrYzFKTTN2SDhlK0F3TUlHdEJnTlZIU01FZ2FVd2dhS0FGQTZMCnpJMXhXOHJwOUFoUERHR1F0cmFLckt0S29ZR0dwSUdETUlHQU1SRXdEd1lEVlFRREV3aHdZWEpwY3k1bWNqRUxNQWtHQTFVRUJoTUMKWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCR2NtRnVZMlV4RGpBTUJnTlZCQWNUQlZCaGNtbHpNUmd3RmdZRFZRUUtFdzlOWVdseQphV1VnWkdVZ1VHRnlhWE14SERBYUJna3Foa2lHOXcwQkNRRVdEWEp2YjNSQWNHRnlhWE11Wm5LQ0FRQXdMZ1lKWUlaSUFZYjRRZ0VFCkJDRVdIMmgwZEhCek9pOHZkM2QzTG5CaGNtbHpMbVp5TDJOaExXTnliQzV3Wlcwd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFBTDgKTGtkK3liYm5OazFXczQwR1RCaW1ZZlMycjd4U3VRVmpLTHg0MEVhUFhPem5Gbmc0VGNDK3Z4dWUxUEt3NzJsb2QreVcycjdJRE91RgpKaTVCbzNudm1hMjdRQ1lSYUgvRGQwSDdDcG9HVFdZeXZVQ294NXROSVB3dVFNTWJiZmtJMWgreW1IbUZ5dVNyS1laakNTRFkvWk9CCk4wOXhxOC84a3pZaWE1c1JTYW0rajdUTkl5clFLNzg5d28zRjRta25rWE5rZWoyWFFScFlqMTNCYzd1MkF3MEI1eTVQMTRZbG9DTjUKU0RYeDAvb29BOEJ6RWRwWnJpTEpYMis0NlV4UUdRRFVNTzBTemo1L0xnVC9wWWdoRmtMczM5ck5DUy9Gb2hmbFl5SzFGWnlkSWZSNQpETENMVGhhWkh3c2o4V0ZodDljMHAyM1JJNzhvYzFUdkFBaz08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDpTdWJqZWN0IHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI+X2NhN2U4ZDMwMWI1MTkzM2FjYzFlNmIxNjNkNDU3NDc1PC9zYW1sOk5hbWVJRD48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgQWRkcmVzcz0iMTcyLjMwLjI0LjE3IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIE5vdE9uT3JBZnRlcj0iMjAwOC0wOC0yMFQwODo0OTozOS4yMDBaIiBSZWNpcGllbnQ9Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIi8+PC9zYW1sOlN1YmplY3RDb25maXJtYXRpb24+PC9zYW1sOlN1YmplY3Q+PHNhbWw6Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMDgtMDgtMjBUMDg6NDQ6MzkuMjAwWiIgTm90T25PckFmdGVyPSIyMDA4LTA4LTIwVDA4OjQ5OjM5LjIwMFoiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWw6QXVkaWVuY2U+dXJuOmZzOnZvdGUucGFyaXMuZnI6MS4wPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0MzoxMC4yNDFaIiBTZXNzaW9uSW5kZXg9IjA3NjQzMWM5OGZiZGMwM2I1N2ZhNmU2ZGY5MTQwMDQ3NDkzZGYyZjViYTZjZmY4M2RmYjBkZThkN2EwYWE1NmEiIFNlc3Npb25Ob3RPbk9yQWZ0ZXI9IjIwMDgtMDgtMjBUMDk6MTM6MTAuMjQxWiIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6U3ViamVjdExvY2FsaXR5IEFkZHJlc3M9IjE3Mi4zMC4yNC4xNyIvPjxzYW1sOkF1dGhuQ29udGV4dD48c2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWw6QXV0aG5Db250ZXh0Pjwvc2FtbDpBdXRoblN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGVTdGF0ZW1lbnQgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5zdWZmaXgiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQuc3VmZml4IiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPmJpczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVpZCIgTmFtZT0idXJuOm9pZDowLjkuMjM0Mi4xOTIwMDMwMC4xMDAuMS4xIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hYmVub2l0QHBhcmlzLmZyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5udW1iZXIiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubnVtYmVyIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPjE1Mjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubmFtZSIgTmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5uYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPk1hbGFrb2ZmPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC51cmJhbmRpc3RyaWN0IiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnVyYmFuZGlzdHJpY3QiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+MTY8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnR5cGUiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQudHlwZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hdmVudWU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=";

		SAMLTokenHandler tokenChecker = new SAMLTokenHandler();

		// Requete invalide (signature OK + certificat KO)
		request.addMokeParameters(Constants.SAML_RESPONSE_REQUEST_PARAM, validResponse);
		BootStrap.getInstance().initializeIDPMetaData("/resources/data/invalid-idp-metadata.xml");		
		BootStrap.getInstance().initializeSPMetaData("/resources/data/BureauDeVote.xml");
		
		try {
			tokenChecker.checkSAMLResponse(request);
			fail("Requete invalide");
		} catch (SAMLTokenExtractorException e) {
			fail("Requete invalide");
		} catch (SignatureValidationException e) {
			fail("Requete invalide");
		} catch (CertificateValidationException e) {
			// OK
		} catch (InvalidAttributeException e) {
			fail("Requete invalide");
		} catch (SAMLParsingException e) {
			fail("Requete invalide");
		} catch (SAMLCheckerException e) {
			fail("Requete invalide");
		}
	}

	public void testCheckSAMLResponseInvalidSignature() {
		MokeHttpServletRequest request = new MokeHttpServletRequest();
		String invalidResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbHA6UmVzcG9uc2UgeG1sbnM6c2FtbHA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIiBJRD0iX2FiMzkyZDRjNWFmNjljNDY5NDc3MjY2OGQ1NTMzNzQ0IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfODYwYmMwYjhhNTRlMWYxZjc5YWRjM2RmNzkwYjEwYzUiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+DQo8ZHM6U2lnbmVkSW5mbyB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+DQo8ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4NCjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+DQo8ZHM6UmVmZXJlbmNlIFVSST0iI184NjBiYzBiOGE1NGUxZjFmNzlhZGMzZGY3OTBiMTBjNSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPg0KPGRzOlRyYW5zZm9ybXMgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPg0KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIvPg0KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxlYzpJbmNsdXNpdmVOYW1lc3BhY2VzIHhtbG5zOmVjPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiIFByZWZpeExpc3Q9ImRzIHNhbWwgeHMiLz48L2RzOlRyYW5zZm9ybT4NCjwvZHM6VHJhbnNmb3Jtcz4NCjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4NCjxkczpEaWdlc3RWYWx1ZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+dFRvbE5QOWVkL1ROYUJNL0RERHViUlB6QU9rPTwvZHM6RGlnZXN0VmFsdWU+DQo8L2RzOlJlZmVyZW5jZT4NCjwvZHM6U2lnbmVkSW5mbz4NCjxkczpTaWduYXR1cmVWYWx1ZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+DQphV05PRmRkQnFqV1JFNDROV0daVEhhMGpHZXBRN1JTZkFneVRCamtLcXRhVlBOWkFJeEYrODdjbXdPc2ZQRC9XaTdtaG5DMnVIQW9XDQpzK1VidzdqazlhUHJ5T1RxcWlzaDJWcmQxNkRPSUhMdWFCdFNlMlZ6Vm9Uby9WUzF5RyswTVJVN0diKzBiS0xkc3NNb1YrR21JUWJiDQp3MFdMcjMvdzlhQ1ZwRlNOQzJHS0JyZmFtZ1h2QjNQM0c5YUQrNFBQbW9hRnZwM2Raa0N3NjZsTmFrRnJ4MW1mRzNReHlxRGY5dUl0DQpBU3o5TUF2ZTJLcHRZZE5Xa09rYkxwZGFMRlV0dFI1T1FFejFMdjF3Tm9PQmlhbmlEZHQ1cHZHN2VyOVBRcjdadWFoOFlKOVhNNEZIDQpPZ3RONXlPeHUwS04vVkg2K2hnNjlhbXV2SDhMMCs4dTE3amx1UT09DQo8L2RzOlNpZ25hdHVyZVZhbHVlPg0KPGRzOktleUluZm8+PGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU+TUlJRWlqQ0NBM0tnQXdJQkFnSUJBVEFOQmdrcWhraUc5dzBCQVFVRkFEQ0JnREVSTUE4R0ExVUVBeE1JY0dGeWFYTXVabkl4Q3pBSg0KQmdOVkJBWVRBbVp5TVJZd0ZBWURWUVFJRXcxSmJHVWdaR1VnUm5KaGJtTmxNUTR3REFZRFZRUUhFd1ZRWVhKcGN6RVlNQllHQTFVRQ0KQ2hNUFRXRnBjbWxsSUdSbElGQmhjbWx6TVJ3d0dnWUpLb1pJaHZjTkFRa0JGZzF5YjI5MFFIQmhjbWx6TG1aeU1CNFhEVEE0TURjeQ0KT0RFMU5ERXhNbG9YRFRBNU1EY3lPREUxTkRFeE1sb3dmakVMTUFrR0ExVUVCaE1DWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCRw0KY21GdVkyVXhHREFXQmdOVkJBb1REMDFoYVhKcFpTQmtaU0JRWVhKcGN6RU1NQW9HQTFVRUN4TURhV1J3TVJFd0R3WURWUVFERXdodw0KWVhKcGN5NW1jakVjTUJvR0NTcUdTSWIzRFFFSkFSWU5jbTl2ZEVCd1lYSnBjeTVtY2pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRA0KZ2dFUEFEQ0NBUW9DZ2dFQkFORVBJWEwyYytYUUE0QnpCMzdhZFpLV2Y3VWR5VE1kU3gzb0o5bGdLdW0zQ2dONmZRY0FHc2pMVjdYdg0KR0lwdDc2cS84NUdmanR2UDBYNlNwVUo4VzYyTDRPVjExbmlXMjR2UTRscVFlMGJDa1hCZ3RDVkUyYS9nZFdxNkdjUjcxOUdPSXF5eg0KUlh4VnN1RFRnQnovMXdzRjJiTnlHS2VwcENDQTA2NFNiR2VEaExqN0VvNWJjemhxMzBQUzNpQnladVladzd3ZmxUNU9NcFhsQWdYSA0KaWlZYVFoSlZxenhPVmxmUTRvbUNaWS9vUzlmWjhqU3oyNTZaeWVIdXc2dGp4ait0SGxIclBrTGIwaUNKVCtMcytGYlhDT2c4M0NZaA0Kcy9LM2FxSk5pN24veFM4cGhXSDd1Y29nVklUWHF3bW9EMmdoUXN5ZEdqNjNxdys5eTVPcDZjc0NBd0VBQWFPQ0FRNHdnZ0VLTUFrRw0KQTFVZEV3UUNNQUF3SFFZRFZSME9CQllFRkM3R3FJRG9MUS9YYmYzK2MxSk0zdkg4ZStBd01JR3RCZ05WSFNNRWdhVXdnYUtBRkE2TA0KekkxeFc4cnA5QWhQREdHUXRyYUtyS3RLb1lHR3BJR0RNSUdBTVJFd0R3WURWUVFERXdod1lYSnBjeTVtY2pFTE1Ba0dBMVVFQmhNQw0KWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCR2NtRnVZMlV4RGpBTUJnTlZCQWNUQlZCaGNtbHpNUmd3RmdZRFZRUUtFdzlOWVdseQ0KYVdVZ1pHVWdVR0Z5YVhNeEhEQWFCZ2txaGtpRzl3MEJDUUVXRFhKdmIzUkFjR0Z5YVhNdVpuS0NBUUF3TGdZSllJWklBWWI0UWdFRQ0KQkNFV0gyaDBkSEJ6T2k4dmQzZDNMbkJoY21sekxtWnlMMk5oTFdOeWJDNXdaVzB3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQUFMOA0KTGtkK3liYm5OazFXczQwR1RCaW1ZZlMycjd4U3VRVmpLTHg0MEVhUFhPem5Gbmc0VGNDK3Z4dWUxUEt3NzJsb2QreVcycjdJRE91Rg0KSmk1Qm8zbnZtYTI3UUNZUmFIL0RkMEg3Q3BvR1RXWXl2VUNveDV0TklQd3VRTU1iYmZrSTFoK3ltSG1GeXVTcktZWmpDU0RZL1pPQg0KTjA5eHE4LzhrellpYTVzUlNhbStqN1ROSXlyUUs3ODl3bzNGNG1rbmtYTmtlajJYUVJwWWoxM0JjN3UyQXcwQjV5NVAxNFlsb0NONQ0KU0RYeDAvb29BOEJ6RWRwWnJpTEpYMis0NlV4UUdRRFVNTzBTemo1L0xnVC9wWWdoRmtMczM5ck5DUy9Gb2hmbFl5SzFGWnlkSWZSNQ0KRExDTFRoYVpId3NqOFdGaHQ5YzBwMjNSSTc4b2MxVHZBQWs9PC9kczpYNTA5Q2VydGlmaWNhdGU+PC9kczpYNTA5RGF0YT48L2RzOktleUluZm8+PC9kczpTaWduYXR1cmU+PHNhbWw6U3ViamVjdCB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDpOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDp0cmFuc2llbnQiPl9jYTdlOGQzMDFiNTE5MzNhY2MxZTZiMTYzZDQ1NzQ3NTwvc2FtbDpOYW1lSUQ+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb25EYXRhIEFkZHJlc3M9IjE3Mi4zMC4yNC4xNyIgSW5SZXNwb25zZVRvPSJlanBrZWJlaGFwZW9kb29pYWRvbm1wb29tcGxtZmdkcGZjZWdoZmNwIiBOb3RPbk9yQWZ0ZXI9IjIwMDgtMDgtMjBUMDg6NDk6MzkuMjAwWiIgUmVjaXBpZW50PSJodHRwczovL3ZvdGUucGFyaXMuZnI6MzQ0My92b3RlL2pzcC9zaXRlL3BsdWdpbnMvbXlsdXRlY2UvRG9NeUx1dGVjZUxvZ2luLmpzcCIvPjwvc2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uPjwvc2FtbDpTdWJqZWN0PjxzYW1sOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDA4LTA4LTIwVDA4OjQ0OjM5LjIwMFoiIE5vdE9uT3JBZnRlcj0iMjAwOC0wOC0yMFQwODo0OTozOS4yMDBaIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjxzYW1sOkF1ZGllbmNlPnVybjpmczp2b3RlLnBhcmlzLmZyOjEuMDwvc2FtbDpBdWRpZW5jZT48L3NhbWw6QXVkaWVuY2VSZXN0cmljdGlvbj48L3NhbWw6Q29uZGl0aW9ucz48c2FtbDpBdXRoblN0YXRlbWVudCBBdXRobkluc3RhbnQ9IjIwMDgtMDgtMjBUMDg6NDM6MTAuMjQxWiIgU2Vzc2lvbkluZGV4PSIwNzY0MzFjOThmYmRjMDNiNTdmYTZlNmRmOTE0MDA0NzQ5M2RmMmY1YmE2Y2ZmODNkZmIwZGU4ZDdhMGFhNTZhIiBTZXNzaW9uTm90T25PckFmdGVyPSIyMDA4LTA4LTIwVDA5OjEzOjEwLjI0MVoiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOlN1YmplY3RMb2NhbGl0eSBBZGRyZXNzPSIxNzIuMzAuMjQuMTciLz48c2FtbDpBdXRobkNvbnRleHQ+PHNhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L3NhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9zYW1sOkF1dGhuQ29udGV4dD48L3NhbWw6QXV0aG5TdGF0ZW1lbnQ+PHNhbWw6QXR0cmlidXRlU3RhdGVtZW50IHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQuc3VmZml4IiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnN1ZmZpeCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5iaXM8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1aWQiIE5hbWU9InVybjpvaWQ6MC45LjIzNDIuMTkyMDAzMDAuMTAwLjEuMSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+YWJlbm9pdEBwYXJpcy5mcjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubnVtYmVyIiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0Lm51bWJlciIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj4xNTI8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0Lm5hbWUiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5NYWxha29mZjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQudXJiYW5kaXN0cmljdCIgTmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC51cmJhbmRpc3RyaWN0IiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPjE2PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC50eXBlIiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnR5cGUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+YXZlbnVlPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48L3NhbWw6QXNzZXJ0aW9uPjwvc2FtbHA6UmVzcG9uc2U+";

		SAMLTokenHandler tokenChecker = new SAMLTokenHandler();

		// Requete invalide (signature KO + certificat OK)
		request.addMokeParameters(Constants.SAML_RESPONSE_REQUEST_PARAM, invalidResponse);
		BootStrap.getInstance().initializeIDPMetaData("/resources/data/valid-idp-metadata.xml");		
		BootStrap.getInstance().initializeSPMetaData("/resources/data/BureauDeVote.xml");
		
		try {
			tokenChecker.checkSAMLResponse(request);
			fail("Requete invalide");
		} catch (SAMLTokenExtractorException e) {
			fail("Requete invalide");
		} catch (SignatureValidationException e) {
			// OK
		} catch (CertificateValidationException e) {
			fail("Requete invalide");
		} catch (InvalidAttributeException e) {
			fail("Requete invalide");
		} catch (SAMLParsingException e) {
			fail("Requete invalide");
		} catch (SAMLCheckerException e) {
			fail("Requete invalide");
		}
	}

	public void testCheckSAMLResponseMissingRequiredAttribute() {
		MokeHttpServletRequest request = new MokeHttpServletRequest();
		String validResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbHA6UmVzcG9uc2UgeG1sbnM6c2FtbHA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIiBJRD0iX2FiMzkyZDRjNWFmNjljNDY5NDc3MjY2OGQ1NTMzNzQ0IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfODYwYmMwYjhhNTRlMWYxZjc5YWRjM2RmNzkwYjEwYzUiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpTaWduZWRJbmZvIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpSZWZlcmVuY2UgVVJJPSIjXzg2MGJjMGI4YTU0ZTFmMWY3OWFkYzNkZjc5MGIxMGM1IiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpUcmFuc2Zvcm1zIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIvPgo8ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGVjOkluY2x1c2l2ZU5hbWVzcGFjZXMgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgUHJlZml4TGlzdD0iZHMgc2FtbCB4cyIvPjwvZHM6VHJhbnNmb3JtPgo8L2RzOlRyYW5zZm9ybXM+CjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4KPGRzOkRpZ2VzdFZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj50VG9sTlA5ZWQvVE5hQk0vREREdWJSUHpBT2s9PC9kczpEaWdlc3RWYWx1ZT4KPC9kczpSZWZlcmVuY2U+CjwvZHM6U2lnbmVkSW5mbz4KPGRzOlNpZ25hdHVyZVZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KYVdOT0ZkZEJxaldSRTQ0TldHWlRIYTBqR2VwUTdSU2ZBZ3lUQmprS3F0YVZQTlpBSXhGKzg3Y213T3NmUEQvV2k3bWhuQzJ1SEFvVwpzK1VidzdqazlhUHJ5T1RxcWlzaDJWcmQxNkRPSUhMdWFCdFNlMlZ6Vm9Uby9WUzF5RyswTVJVN0diKzBiS0xkc3NNb1YrR21JUWJiCncwV0xyMy93OWFDVnBGU05DMkdLQnJmYW1nWHZCM1AzRzlhRCs0UFFtb2FGdnAzZFprQ3c2NmxOYWtGcngxbWZHM1F4eXFEZjl1SXQKQVN6OU1BdmUyS3B0WWROV2tPa2JMcGRhTEZVdHRSNU9RRXoxTHYxd05vT0JpYW5pRGR0NXB2RzdlcjlQUXI3WnVhaDhZSjlYTTRGSApPZ3RONXlPeHUwS04vVkg2K2hnNjlhbXV2SDhMMCs4dTE3amx1UT09CjwvZHM6U2lnbmF0dXJlVmFsdWU+CjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUVpakNDQTNLZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRVUZBRENCZ0RFUk1BOEdBMVVFQXhNSWNHRnlhWE11Wm5JeEN6QUoKQmdOVkJBWVRBbVp5TVJZd0ZBWURWUVFJRXcxSmJHVWdaR1VnUm5KaGJtTmxNUTR3REFZRFZRUUhFd1ZRWVhKcGN6RVlNQllHQTFVRQpDaE1QVFdGcGNtbGxJR1JsSUZCaGNtbHpNUnd3R2dZSktvWklodmNOQVFrQkZnMXliMjkwUUhCaGNtbHpMbVp5TUI0WERUQTRNRGN5Ck9ERTFOREV4TWxvWERUQTVNRGN5T0RFMU5ERXhNbG93ZmpFTE1Ba0dBMVVFQmhNQ1puSXhGakFVQmdOVkJBZ1REVWxzWlNCa1pTQkcKY21GdVkyVXhHREFXQmdOVkJBb1REMDFoYVhKcFpTQmtaU0JRWVhKcGN6RU1NQW9HQTFVRUN4TURhV1J3TVJFd0R3WURWUVFERXdodwpZWEpwY3k1bWNqRWNNQm9HQ1NxR1NJYjNEUUVKQVJZTmNtOXZkRUJ3WVhKcGN5NW1jakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnRVBBRENDQVFvQ2dnRUJBTkVQSVhMMmMrWFFBNEJ6QjM3YWRaS1dmN1VkeVRNZFN4M29KOWxnS3VtM0NnTjZmUWNBR3NqTFY3WHYKR0lwdDc2cS84NUdmanR2UDBYNlNwVUo4VzYyTDRPVjExbmlXMjR2UTRscVFlMGJDa1hCZ3RDVkUyYS9nZFdxNkdjUjcxOUdPSXF5egpSWHhWc3VEVGdCei8xd3NGMmJOeUdLZXBwQ0NBMDY0U2JHZURoTGo3RW81YmN6aHEzMFBTM2lCeVp1WVp3N3dmbFQ1T01wWGxBZ1hICmlpWWFRaEpWcXp4T1ZsZlE0b21DWlkvb1M5Zlo4alN6MjU2WnllSHV3NnRqeGordEhsSHJQa0xiMGlDSlQrTHMrRmJYQ09nODNDWWgKcy9LM2FxSk5pN24veFM4cGhXSDd1Y29nVklUWHF3bW9EMmdoUXN5ZEdqNjNxdys5eTVPcDZjc0NBd0VBQWFPQ0FRNHdnZ0VLTUFrRwpBMVVkRXdRQ01BQXdIUVlEVlIwT0JCWUVGQzdHcUlEb0xRL1hiZjMrYzFKTTN2SDhlK0F3TUlHdEJnTlZIU01FZ2FVd2dhS0FGQTZMCnpJMXhXOHJwOUFoUERHR1F0cmFLckt0S29ZR0dwSUdETUlHQU1SRXdEd1lEVlFRREV3aHdZWEpwY3k1bWNqRUxNQWtHQTFVRUJoTUMKWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCR2NtRnVZMlV4RGpBTUJnTlZCQWNUQlZCaGNtbHpNUmd3RmdZRFZRUUtFdzlOWVdseQphV1VnWkdVZ1VHRnlhWE14SERBYUJna3Foa2lHOXcwQkNRRVdEWEp2YjNSQWNHRnlhWE11Wm5LQ0FRQXdMZ1lKWUlaSUFZYjRRZ0VFCkJDRVdIMmgwZEhCek9pOHZkM2QzTG5CaGNtbHpMbVp5TDJOaExXTnliQzV3Wlcwd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFBTDgKTGtkK3liYm5OazFXczQwR1RCaW1ZZlMycjd4U3VRVmpLTHg0MEVhUFhPem5Gbmc0VGNDK3Z4dWUxUEt3NzJsb2QreVcycjdJRE91RgpKaTVCbzNudm1hMjdRQ1lSYUgvRGQwSDdDcG9HVFdZeXZVQ294NXROSVB3dVFNTWJiZmtJMWgreW1IbUZ5dVNyS1laakNTRFkvWk9CCk4wOXhxOC84a3pZaWE1c1JTYW0rajdUTkl5clFLNzg5d28zRjRta25rWE5rZWoyWFFScFlqMTNCYzd1MkF3MEI1eTVQMTRZbG9DTjUKU0RYeDAvb29BOEJ6RWRwWnJpTEpYMis0NlV4UUdRRFVNTzBTemo1L0xnVC9wWWdoRmtMczM5ck5DUy9Gb2hmbFl5SzFGWnlkSWZSNQpETENMVGhhWkh3c2o4V0ZodDljMHAyM1JJNzhvYzFUdkFBaz08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDpTdWJqZWN0IHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI+X2NhN2U4ZDMwMWI1MTkzM2FjYzFlNmIxNjNkNDU3NDc1PC9zYW1sOk5hbWVJRD48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgQWRkcmVzcz0iMTcyLjMwLjI0LjE3IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIE5vdE9uT3JBZnRlcj0iMjAwOC0wOC0yMFQwODo0OTozOS4yMDBaIiBSZWNpcGllbnQ9Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIi8+PC9zYW1sOlN1YmplY3RDb25maXJtYXRpb24+PC9zYW1sOlN1YmplY3Q+PHNhbWw6Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMDgtMDgtMjBUMDg6NDQ6MzkuMjAwWiIgTm90T25PckFmdGVyPSIyMDA4LTA4LTIwVDA4OjQ5OjM5LjIwMFoiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWw6QXVkaWVuY2U+dXJuOmZzOnZvdGUucGFyaXMuZnI6MS4wPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0MzoxMC4yNDFaIiBTZXNzaW9uSW5kZXg9IjA3NjQzMWM5OGZiZGMwM2I1N2ZhNmU2ZGY5MTQwMDQ3NDkzZGYyZjViYTZjZmY4M2RmYjBkZThkN2EwYWE1NmEiIFNlc3Npb25Ob3RPbk9yQWZ0ZXI9IjIwMDgtMDgtMjBUMDk6MTM6MTAuMjQxWiIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6U3ViamVjdExvY2FsaXR5IEFkZHJlc3M9IjE3Mi4zMC4yNC4xNyIvPjxzYW1sOkF1dGhuQ29udGV4dD48c2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWw6QXV0aG5Db250ZXh0Pjwvc2FtbDpBdXRoblN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGVTdGF0ZW1lbnQgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5zdWZmaXgiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQuc3VmZml4IiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPmJpczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVpZCIgTmFtZT0idXJuOm9pZDowLjkuMjM0Mi4xOTIwMDMwMC4xMDAuMS4xIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hYmVub2l0QHBhcmlzLmZyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5udW1iZXIiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubnVtYmVyIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPjE1Mjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubmFtZSIgTmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5uYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPk1hbGFrb2ZmPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC51cmJhbmRpc3RyaWN0IiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnVyYmFuZGlzdHJpY3QiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+MTY8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnR5cGUiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQudHlwZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hdmVudWU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=";

		SAMLTokenHandler tokenChecker = new SAMLTokenHandler();

		// Requete invalide (signature OK + certificat OK + Attributes KO)
		request.addMokeParameters(Constants.SAML_RESPONSE_REQUEST_PARAM, validResponse);
		BootStrap.getInstance().initializeIDPMetaData("/resources/data/valid-idp-metadata.xml");
		BootStrap.getInstance().initializeSPMetaData("/resources/data/ExtraAttributeBureauDeVote.xml");
		
		try {
			tokenChecker.checkSAMLResponse(request);
			fail("Requete invalide");
		} catch (SAMLTokenExtractorException e) {
			fail("Requete invalide");
		} catch (SignatureValidationException e) {
			fail("Requete invalide");
		} catch (CertificateValidationException e) {
			fail("Requete invalide");
		} catch (InvalidAttributeException e) {
			// OK
		} catch (SAMLParsingException e) {
			fail("Requete invalide");
		} catch (SAMLCheckerException e) {
			fail("Requete invalide");
		}
	}
	
	public void testCheckSAMLResponseWithRequiredAttribute() {
		MokeHttpServletRequest request = new MokeHttpServletRequest();
		String validResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbHA6UmVzcG9uc2UgeG1sbnM6c2FtbHA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgRGVzdGluYXRpb249Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIiBJRD0iX2FiMzkyZDRjNWFmNjljNDY5NDc3MjY2OGQ1NTMzNzQ0IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfODYwYmMwYjhhNTRlMWYxZjc5YWRjM2RmNzkwYjEwYzUiIElzc3VlSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0NDozOS4yMDBaIiBWZXJzaW9uPSIyLjAiPjxzYW1sOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+dXJuOmZpOmRpY3RhbzpzaGliOjEuMDwvc2FtbDpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpTaWduZWRJbmZvIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIi8+CjxkczpSZWZlcmVuY2UgVVJJPSIjXzg2MGJjMGI4YTU0ZTFmMWY3OWFkYzNkZjc5MGIxMGM1IiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+CjxkczpUcmFuc2Zvcm1zIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyIvPgo8ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGVjOkluY2x1c2l2ZU5hbWVzcGFjZXMgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgUHJlZml4TGlzdD0iZHMgc2FtbCB4cyIvPjwvZHM6VHJhbnNmb3JtPgo8L2RzOlRyYW5zZm9ybXM+CjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjc2hhMSIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiLz4KPGRzOkRpZ2VzdFZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj50VG9sTlA5ZWQvVE5hQk0vREREdWJSUHpBT2s9PC9kczpEaWdlc3RWYWx1ZT4KPC9kczpSZWZlcmVuY2U+CjwvZHM6U2lnbmVkSW5mbz4KPGRzOlNpZ25hdHVyZVZhbHVlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj4KYVdOT0ZkZEJxaldSRTQ0TldHWlRIYTBqR2VwUTdSU2ZBZ3lUQmprS3F0YVZQTlpBSXhGKzg3Y213T3NmUEQvV2k3bWhuQzJ1SEFvVwpzK1VidzdqazlhUHJ5T1RxcWlzaDJWcmQxNkRPSUhMdWFCdFNlMlZ6Vm9Uby9WUzF5RyswTVJVN0diKzBiS0xkc3NNb1YrR21JUWJiCncwV0xyMy93OWFDVnBGU05DMkdLQnJmYW1nWHZCM1AzRzlhRCs0UFFtb2FGdnAzZFprQ3c2NmxOYWtGcngxbWZHM1F4eXFEZjl1SXQKQVN6OU1BdmUyS3B0WWROV2tPa2JMcGRhTEZVdHRSNU9RRXoxTHYxd05vT0JpYW5pRGR0NXB2RzdlcjlQUXI3WnVhaDhZSjlYTTRGSApPZ3RONXlPeHUwS04vVkg2K2hnNjlhbXV2SDhMMCs4dTE3amx1UT09CjwvZHM6U2lnbmF0dXJlVmFsdWU+CjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUVpakNDQTNLZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRVUZBRENCZ0RFUk1BOEdBMVVFQXhNSWNHRnlhWE11Wm5JeEN6QUoKQmdOVkJBWVRBbVp5TVJZd0ZBWURWUVFJRXcxSmJHVWdaR1VnUm5KaGJtTmxNUTR3REFZRFZRUUhFd1ZRWVhKcGN6RVlNQllHQTFVRQpDaE1QVFdGcGNtbGxJR1JsSUZCaGNtbHpNUnd3R2dZSktvWklodmNOQVFrQkZnMXliMjkwUUhCaGNtbHpMbVp5TUI0WERUQTRNRGN5Ck9ERTFOREV4TWxvWERUQTVNRGN5T0RFMU5ERXhNbG93ZmpFTE1Ba0dBMVVFQmhNQ1puSXhGakFVQmdOVkJBZ1REVWxzWlNCa1pTQkcKY21GdVkyVXhHREFXQmdOVkJBb1REMDFoYVhKcFpTQmtaU0JRWVhKcGN6RU1NQW9HQTFVRUN4TURhV1J3TVJFd0R3WURWUVFERXdodwpZWEpwY3k1bWNqRWNNQm9HQ1NxR1NJYjNEUUVKQVJZTmNtOXZkRUJ3WVhKcGN5NW1jakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFECmdnRVBBRENDQVFvQ2dnRUJBTkVQSVhMMmMrWFFBNEJ6QjM3YWRaS1dmN1VkeVRNZFN4M29KOWxnS3VtM0NnTjZmUWNBR3NqTFY3WHYKR0lwdDc2cS84NUdmanR2UDBYNlNwVUo4VzYyTDRPVjExbmlXMjR2UTRscVFlMGJDa1hCZ3RDVkUyYS9nZFdxNkdjUjcxOUdPSXF5egpSWHhWc3VEVGdCei8xd3NGMmJOeUdLZXBwQ0NBMDY0U2JHZURoTGo3RW81YmN6aHEzMFBTM2lCeVp1WVp3N3dmbFQ1T01wWGxBZ1hICmlpWWFRaEpWcXp4T1ZsZlE0b21DWlkvb1M5Zlo4alN6MjU2WnllSHV3NnRqeGordEhsSHJQa0xiMGlDSlQrTHMrRmJYQ09nODNDWWgKcy9LM2FxSk5pN24veFM4cGhXSDd1Y29nVklUWHF3bW9EMmdoUXN5ZEdqNjNxdys5eTVPcDZjc0NBd0VBQWFPQ0FRNHdnZ0VLTUFrRwpBMVVkRXdRQ01BQXdIUVlEVlIwT0JCWUVGQzdHcUlEb0xRL1hiZjMrYzFKTTN2SDhlK0F3TUlHdEJnTlZIU01FZ2FVd2dhS0FGQTZMCnpJMXhXOHJwOUFoUERHR1F0cmFLckt0S29ZR0dwSUdETUlHQU1SRXdEd1lEVlFRREV3aHdZWEpwY3k1bWNqRUxNQWtHQTFVRUJoTUMKWm5JeEZqQVVCZ05WQkFnVERVbHNaU0JrWlNCR2NtRnVZMlV4RGpBTUJnTlZCQWNUQlZCaGNtbHpNUmd3RmdZRFZRUUtFdzlOWVdseQphV1VnWkdVZ1VHRnlhWE14SERBYUJna3Foa2lHOXcwQkNRRVdEWEp2YjNSQWNHRnlhWE11Wm5LQ0FRQXdMZ1lKWUlaSUFZYjRRZ0VFCkJDRVdIMmgwZEhCek9pOHZkM2QzTG5CaGNtbHpMbVp5TDJOaExXTnliQzV3Wlcwd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFBTDgKTGtkK3liYm5OazFXczQwR1RCaW1ZZlMycjd4U3VRVmpLTHg0MEVhUFhPem5Gbmc0VGNDK3Z4dWUxUEt3NzJsb2QreVcycjdJRE91RgpKaTVCbzNudm1hMjdRQ1lSYUgvRGQwSDdDcG9HVFdZeXZVQ294NXROSVB3dVFNTWJiZmtJMWgreW1IbUZ5dVNyS1laakNTRFkvWk9CCk4wOXhxOC84a3pZaWE1c1JTYW0rajdUTkl5clFLNzg5d28zRjRta25rWE5rZWoyWFFScFlqMTNCYzd1MkF3MEI1eTVQMTRZbG9DTjUKU0RYeDAvb29BOEJ6RWRwWnJpTEpYMis0NlV4UUdRRFVNTzBTemo1L0xnVC9wWWdoRmtMczM5ck5DUy9Gb2hmbFl5SzFGWnlkSWZSNQpETENMVGhhWkh3c2o4V0ZodDljMHAyM1JJNzhvYzFUdkFBaz08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDpTdWJqZWN0IHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI+X2NhN2U4ZDMwMWI1MTkzM2FjYzFlNmIxNjNkNDU3NDc1PC9zYW1sOk5hbWVJRD48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWw6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgQWRkcmVzcz0iMTcyLjMwLjI0LjE3IiBJblJlc3BvbnNlVG89ImVqcGtlYmVoYXBlb2Rvb2lhZG9ubXBvb21wbG1mZ2RwZmNlZ2hmY3AiIE5vdE9uT3JBZnRlcj0iMjAwOC0wOC0yMFQwODo0OTozOS4yMDBaIiBSZWNpcGllbnQ9Imh0dHBzOi8vdm90ZS5wYXJpcy5mcjozNDQzL3ZvdGUvanNwL3NpdGUvcGx1Z2lucy9teWx1dGVjZS9Eb015THV0ZWNlTG9naW4uanNwIi8+PC9zYW1sOlN1YmplY3RDb25maXJtYXRpb24+PC9zYW1sOlN1YmplY3Q+PHNhbWw6Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMDgtMDgtMjBUMDg6NDQ6MzkuMjAwWiIgTm90T25PckFmdGVyPSIyMDA4LTA4LTIwVDA4OjQ5OjM5LjIwMFoiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWw6QXVkaWVuY2U+dXJuOmZzOnZvdGUucGFyaXMuZnI6MS4wPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAwOC0wOC0yMFQwODo0MzoxMC4yNDFaIiBTZXNzaW9uSW5kZXg9IjA3NjQzMWM5OGZiZGMwM2I1N2ZhNmU2ZGY5MTQwMDQ3NDkzZGYyZjViYTZjZmY4M2RmYjBkZThkN2EwYWE1NmEiIFNlc3Npb25Ob3RPbk9yQWZ0ZXI9IjIwMDgtMDgtMjBUMDk6MTM6MTAuMjQxWiIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6U3ViamVjdExvY2FsaXR5IEFkZHJlc3M9IjE3Mi4zMC4yNC4xNyIvPjxzYW1sOkF1dGhuQ29udGV4dD48c2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWw6QXV0aG5Db250ZXh0Pjwvc2FtbDpBdXRoblN0YXRlbWVudD48c2FtbDpBdHRyaWJ1dGVTdGF0ZW1lbnQgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5zdWZmaXgiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQuc3VmZml4IiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPmJpczwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVpZCIgTmFtZT0idXJuOm9pZDowLjkuMjM0Mi4xOTIwMDMwMC4xMDAuMS4xIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hYmVub2l0QHBhcmlzLmZyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5udW1iZXIiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubnVtYmVyIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPjE1Mjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQubmFtZSIgTmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC5uYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPk1hbGFrb2ZmPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEZyaWVuZGx5TmFtZT0idXNlci5ob21lLWluZm8ucG9zdGFsLnN0cmVldC51cmJhbmRpc3RyaWN0IiBOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnVyYmFuZGlzdHJpY3QiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+MTY8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgRnJpZW5kbHlOYW1lPSJ1c2VyLmhvbWUtaW5mby5wb3N0YWwuc3RyZWV0LnR5cGUiIE5hbWU9InVzZXIuaG9tZS1pbmZvLnBvc3RhbC5zdHJlZXQudHlwZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDpiYXNpYyI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hdmVudWU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=";

		SAMLTokenHandler tokenChecker = new SAMLTokenHandler();

		// Requete valide (signature OK + certificat OK + Attributes OK)
		request.addMokeParameters(Constants.SAML_RESPONSE_REQUEST_PARAM, validResponse);
		BootStrap.getInstance().initializeIDPMetaData("/resources/data/valid-idp-metadata.xml");
		BootStrap.getInstance().initializeSPMetaData("/resources/data/RequiredAttributeBureauDeVote.xml");

		try {
			tokenChecker.checkSAMLResponse(request);
		} catch (SAMLTokenExtractorException e) {
			fail("Requete invalide");
		} catch (SignatureValidationException e) {
			fail("Requete invalide");
		} catch (CertificateValidationException e) {
			fail("Requete invalide");
		} catch (InvalidAttributeException e) {
			fail("Requete invalide");
		} catch (SAMLParsingException e) {
			fail("Requete invalide");
		} catch (SAMLCheckerException e) {
			// OK Assertion expirée
		}
	}
}
